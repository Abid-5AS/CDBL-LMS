generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  DEPT_HEAD
  HR_ADMIN
  HR_HEAD
  CEO
}

enum LeaveType {
  EARNED
  CASUAL
  MEDICAL
  EXTRAWITHPAY
  EXTRAWITHOUTPAY
  MATERNITY
  PATERNITY
  STUDY
  SPECIAL_DISABILITY
  QUARANTINE
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  password   String?
  empCode    String?  @unique
  role       Role     @default(EMPLOYEE)
  department String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  leaves     LeaveRequest[]
  balances   Balance[]
  approvals  Approval[]   @relation("ApprovalApprover")
}

model LeaveRequest {
  id              Int           @id @default(autoincrement())
  requesterId     Int
  type            LeaveType
  startDate       DateTime
  endDate         DateTime
  workingDays     Int
  reason          String
  needsCertificate Boolean      @default(false)
  certificateUrl  String?       // future upload
  status          LeaveStatus   @default(DRAFT)
  policyVersion   String        // e.g. "v1.1"
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  requester       User          @relation(fields: [requesterId], references: [id])
  approvals       Approval[]
}

enum ApprovalDecision {
  APPROVED
  REJECTED
  FORWARDED
  PENDING
}

model Approval {
  id          Int              @id @default(autoincrement())
  leaveId     Int
  step        Int              // Step in approval chain: 1=HR_ADMIN, 2=DEPT_HEAD, 3=HR_HEAD, 4=CEO
  approverId  Int
  decision    ApprovalDecision @default(PENDING)
  toRole      String?          // Role forwarded to (if decision is FORWARDED)
  comment     String?
  decidedAt   DateTime?

  leave       LeaveRequest     @relation(fields: [leaveId], references: [id])
  approver    User             @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([leaveId])
}

model Balance {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      LeaveType
  year      Int
  opening   Int      // carry-forward (for EL)
  accrued   Int      // e.g., EL accrual 2 days / month
  used      Int      @default(0)
  closing   Int

  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, type, year])
}

model Holiday {
  id         Int      @id @default(autoincrement())
  date       DateTime @unique
  name       String
  isOptional Boolean  @default(false)
}

model PolicyConfig {
  id         Int       @id @default(autoincrement())
  leaveType  LeaveType @unique
  maxDays    Int?
  minDays    Int?
  noticeDays Int?
  carryLimit Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorEmail  String
  action      String
  targetEmail String?
  details     Json?
  createdAt   DateTime @default(now())

  @@index([createdAt])
}

model OrgSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   Int?     // User ID
}
