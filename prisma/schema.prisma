generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  DEPT_HEAD
  HR_ADMIN
  HR_HEAD
  CEO
  SYSTEM_ADMIN
}

enum LeaveType {
  EARNED
  CASUAL
  MEDICAL
  EXTRAWITHPAY
  EXTRAWITHOUTPAY
  MATERNITY
  PATERNITY
  STUDY
  SPECIAL_DISABILITY
  QUARANTINE
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  RETURNED
  CANCELLATION_REQUESTED
  RECALLED
}

model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  password   String?
  empCode    String?  @unique
  role       Role     @default(EMPLOYEE)
  department String?
  deptHeadId Int? // User ID of department head (self-relation)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  leaves      LeaveRequest[]
  balances    Balance[]
  approvals   Approval[]     @relation("ApprovalApprover")
  deptHead    User?          @relation("HeadToMembers", fields: [deptHeadId], references: [id])
  teamMembers User[]         @relation("HeadToMembers")

  @@index([deptHeadId])
}

model LeaveRequest {
  id                    Int         @id @default(autoincrement())
  requesterId           Int
  type                  LeaveType
  startDate             DateTime
  endDate               DateTime
  workingDays           Int
  reason                String
  needsCertificate      Boolean     @default(false)
  certificateUrl        String? // medical certificate upload
  fitnessCertificateUrl String? // fitness certificate for ML > 7 days on return
  status                LeaveStatus @default(DRAFT)
  policyVersion         String // e.g. "v2.0"
  isModified            Boolean     @default(false) // True if request was returned and resubmitted
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  requester User           @relation(fields: [requesterId], references: [id])
  approvals Approval[]
  comments  LeaveComment[]
  versions  LeaveVersion[]

  @@index([requesterId, status])
}

enum ApprovalDecision {
  APPROVED
  REJECTED
  FORWARDED
  PENDING
}

model Approval {
  id         Int              @id @default(autoincrement())
  leaveId    Int
  step       Int // Step in approval chain: 1=HR_ADMIN, 2=DEPT_HEAD, 3=HR_HEAD, 4=CEO
  approverId Int
  decision   ApprovalDecision @default(PENDING)
  toRole     String? // Role forwarded to (if decision is FORWARDED)
  comment    String?
  decidedAt  DateTime?

  leave    LeaveRequest @relation(fields: [leaveId], references: [id])
  approver User         @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([leaveId])
}

model Balance {
  id      Int       @id @default(autoincrement())
  userId  Int
  type    LeaveType
  year    Int
  opening Int // carry-forward (for EL)
  accrued Int // e.g., EL accrual 2 days / month
  used    Int       @default(0)
  closing Int

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, type, year])
}

model Holiday {
  id         Int      @id @default(autoincrement())
  date       DateTime @unique
  name       String
  isOptional Boolean  @default(false)
}

model PolicyConfig {
  id         Int       @id @default(autoincrement())
  leaveType  LeaveType @unique
  maxDays    Int?
  minDays    Int?
  noticeDays Int?
  carryLimit Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorEmail  String
  action      String
  targetEmail String?
  details     Json?
  createdAt   DateTime @default(now())

  @@index([createdAt])
}

model LeaveComment {
  id         Int      @id @default(autoincrement())
  leaveId    Int
  authorId   Int
  authorRole String // Role of the person who wrote the comment
  comment    String
  createdAt  DateTime @default(now())

  leave LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)

  @@index([leaveId])
}

model LeaveVersion {
  id          Int      @id @default(autoincrement())
  leaveId     Int
  version     Int // Version number (1, 2, 3, etc.)
  data        Json // JSON snapshot of the leave request at this version
  createdAt   DateTime @default(now())
  createdById Int
  createdByRole String // Role of person who created this version (usually EMPLOYEE on resubmit)

  leave LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)

  @@index([leaveId])
  @@index([leaveId, version])
}

model OrgSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   Int? // User ID
}

// 2FA OTP (One-Time Password) Model
model OtpCode {
  id           Int      @id @default(autoincrement())
  userId       Int
  email        String
  code         String // 6-digit code
  expiresAt    DateTime
  verified     Boolean  @default(false)
  attempts     Int      @default(0) // Track verification attempts
  ipAddress    String? // Track IP for security
  createdAt    DateTime @default(now())

  @@index([email, verified])
  @@index([expiresAt])
  @@map("OtpCode")
}
