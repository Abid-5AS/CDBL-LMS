generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  EMPLOYEE
  DEPT_HEAD
  HR_ADMIN
  HR_HEAD
  CEO
  SYSTEM_ADMIN
}

enum LeaveType {
  EARNED
  CASUAL
  MEDICAL
  EXTRAWITHPAY
  EXTRAWITHOUTPAY
  MATERNITY
  PATERNITY
  STUDY
  SPECIAL_DISABILITY
  QUARANTINE
  SPECIAL // EL excess >60 days, usable for medical or rest outside Bangladesh (Policy 6.19.c)
}

enum LeaveStatus {
  DRAFT
  SUBMITTED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  RETURNED
  CANCELLATION_REQUESTED
  RECALLED
}

model User {
  id         Int       @id @default(autoincrement())
  name       String
  email      String    @unique
  password   String?
  empCode    String?   @unique
  role       Role      @default(EMPLOYEE)
  department String?
  deptHeadId     Int?       // User ID of department head (self-relation)
  joinDate       DateTime? // Service start date for eligibility calculations (Policy 6.18)
  retirementDate DateTime? // Expected retirement date for study leave validation (Policy 6.25.a)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  leaves              LeaveRequest[]
  balances            Balance[]
  approvals           Approval[]           @relation("ApprovalApprover")
  deptHead            User?                @relation("HeadToMembers", fields: [deptHeadId], references: [id])
  teamMembers         User[]               @relation("HeadToMembers")
  encashmentRequests  EncashmentRequest[]
  encashmentApprovals EncashmentRequest[]  @relation("EncashmentApprover")

  @@index([deptHeadId])
}

model LeaveRequest {
  id                    Int         @id @default(autoincrement())
  requesterId           Int
  type                  LeaveType
  startDate             DateTime
  endDate               DateTime
  workingDays           Int
  reason                String
  needsCertificate      Boolean     @default(false)
  certificateUrl        String? // medical certificate upload
  fitnessCertificateUrl String? // fitness certificate for ML > 7 days on return
  status                LeaveStatus @default(DRAFT)
  policyVersion         String // e.g. "v2.0"
  isModified            Boolean     @default(false) // True if request was returned and resubmitted
  parentLeaveId         Int? // For extension/linked requests - references original leave
  isExtension           Boolean     @default(false) // True if this is an extension request
  isCancellationRequest Boolean     @default(false) // True if this is a cancellation request (partial or full)
  isPartialCancellation Boolean     @default(false) // True if this is a partial cancellation request
  originalEndDate       DateTime? // For partial cancellation: stores the original end date before cancellation
  cancellationReason    String? // Reason for cancellation request
  incidentDate          DateTime? // For Special Disability Leave: Date of disabling incident (Policy 6.22)
  payCalculation        Json? // For Special Disability Leave: Pay breakdown { fullPayDays, halfPayDays, unPaidDays }
  studyLeaveDocuments   Json? // For Study Leave: { admissionLetterUrl, loanAgreementUrl, feeReceiptUrl, courseDetails: { name, institution, duration, completionDate } }
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  requester    User           @relation(fields: [requesterId], references: [id])
  approvals    Approval[]
  comments     LeaveComment[]
  versions     LeaveVersion[]
  parentLeave  LeaveRequest?  @relation("LeaveExtension", fields: [parentLeaveId], references: [id])
  extensions   LeaveRequest[] @relation("LeaveExtension")

  @@index([requesterId, status])
  @@index([parentLeaveId])
  @@index([status, startDate]) // Optimize dashboard stats queries
  @@index([status, updatedAt]) // Optimize processed today queries
  @@index([startDate, endDate, status]) // Optimize employees on leave queries
  @@index([type, status, startDate]) // Optimize leave type breakdown queries
}

enum ApprovalDecision {
  APPROVED
  REJECTED
  FORWARDED
  PENDING
  RETURNED
}

model Approval {
  id         Int              @id @default(autoincrement())
  leaveId    Int
  step       Int // Step in approval chain: 1=HR_ADMIN, 2=DEPT_HEAD, 3=HR_HEAD, 4=CEO
  approverId Int
  decision   ApprovalDecision @default(PENDING)
  toRole     String? // Role forwarded to (if decision is FORWARDED)
  comment    String?
  decidedAt  DateTime?

  leave    LeaveRequest @relation(fields: [leaveId], references: [id])
  approver User         @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([leaveId])
  @@index([approverId, decision]) // Optimize pending approvals query
  @@index([approverId, decidedAt]) // Optimize approval history queries
}

model Balance {
  id      Int       @id @default(autoincrement())
  userId  Int
  type    LeaveType
  year    Int
  opening Int // carry-forward (for EL)
  accrued Int // e.g., EL accrual 2 days / month
  used    Int       @default(0)
  closing Int

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, type, year])
}

model Holiday {
  id         Int      @id @default(autoincrement())
  date       DateTime @unique
  name       String
  isOptional Boolean  @default(false)
}

model PolicyConfig {
  id         Int       @id @default(autoincrement())
  leaveType  LeaveType @unique
  maxDays    Int?
  minDays    Int?
  noticeDays Int?
  carryLimit Int?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorEmail  String
  action      String
  targetEmail String?
  details     Json?
  createdAt   DateTime @default(now())

  @@index([createdAt])
}

model LeaveComment {
  id         Int      @id @default(autoincrement())
  leaveId    Int
  authorId   Int
  authorRole String // Role of the person who wrote the comment
  comment    String
  createdAt  DateTime @default(now())

  leave LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)

  @@index([leaveId])
}

model LeaveVersion {
  id          Int      @id @default(autoincrement())
  leaveId     Int
  version     Int // Version number (1, 2, 3, etc.)
  data        Json // JSON snapshot of the leave request at this version
  createdAt   DateTime @default(now())
  createdById Int
  createdByRole String // Role of person who created this version (usually EMPLOYEE on resubmit)

  leave LeaveRequest @relation(fields: [leaveId], references: [id], onDelete: Cascade)

  @@index([leaveId])
  @@index([leaveId, version])
}

enum EncashmentStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

// EL Encashment Request (Policy 6.19.f)
// Employees can encash EL balance exceeding 10 days
model EncashmentRequest {
  id               Int               @id @default(autoincrement())
  userId           Int
  year             Int // Year of EL balance being encashed
  daysRequested    Int // Days employee wants to encash
  balanceAtRequest Int // EL balance at time of request (for audit)
  reason           String? // Optional reason for encashment
  status           EncashmentStatus  @default(PENDING)
  approvedBy       Int? // User ID of approver (typically CEO)
  approvedAt       DateTime?
  rejectionReason  String?
  paidAt           DateTime? // When payment was processed
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  user     User  @relation(fields: [userId], references: [id])
  approver User? @relation("EncashmentApprover", fields: [approvedBy], references: [id])

  @@index([userId, status])
  @@index([status])
}

model OrgSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   Int? // User ID
}

// 2FA OTP (One-Time Password) Model
model OtpCode {
  id           Int      @id @default(autoincrement())
  userId       Int
  email        String
  code         String // 6-digit code
  expiresAt    DateTime
  verified     Boolean  @default(false)
  attempts     Int      @default(0) // Track verification attempts
  ipAddress    String? // Track IP for security
  createdAt    DateTime @default(now())

  @@index([email, verified])
  @@index([expiresAt])
  @@map("OtpCode")
}

enum NotificationType {
  LEAVE_SUBMITTED
  LEAVE_APPROVED
  LEAVE_REJECTED
  LEAVE_RETURNED
  LEAVE_FORWARDED
  LEAVE_CANCELLED
  LEAVE_CANCELLATION_REQUESTED
  LEAVE_APPROACHING
  APPROVAL_REQUIRED
  ENCASHMENT_APPROVED
  ENCASHMENT_REJECTED
  SYSTEM_ANNOUNCEMENT
}

// Real-time notification system
model Notification {
  id         Int              @id @default(autoincrement())
  userId     Int // Recipient user ID
  type       NotificationType
  title      String
  message    String
  link       String? // Optional link to related resource (e.g., /leaves/123)
  leaveId    Int? // Related leave request ID
  read       Boolean          @default(false)
  readAt     DateTime?
  createdAt  DateTime         @default(now())
  expiresAt  DateTime? // Optional expiry for time-sensitive notifications

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([createdAt])
}
